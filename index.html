<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masowy Edytor Linków PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Biblioteki do manipulacji PDF i ZIP -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Biblioteka do renderowania miniaturek PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .drop-zone { border: 2px dashed #cbd5e1; }
        .drop-zone.dragover { border-color: #4f46e5; background-color: #eef2ff; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .file-section th, .file-section td { padding: 12px; vertical-align: top; }
        .editable-cell { cursor: pointer; }
        .editable-cell-content { min-height: 40px; word-break: break-all; }
        .seamless-textarea {
            width: 100%;
            border: none;
            background-color: transparent;
            padding: 0;
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            resize: none;
            outline: none;
            color: inherit;
            word-break: break-all;
        }
        .cell-modified {
            background-color: #f0fdf4; /* Jasnozielone tło */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-8 max-w-7xl">
        <div class="relative">
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Masowy Edytor Linków PDF</h1>
                <p class="mt-2 text-lg text-gray-600">Wgraj wiele plików PDF, edytuj linki i pobierz wszystko w jednym pliku ZIP.</p>
            </header>
            <button id="back-to-start-btn" class="hidden absolute top-0 right-0 bg-white p-2 rounded-full shadow-md hover:bg-gray-200 transition" title="Wróć do początku">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
                </svg>
            </button>
        </div>

        <main class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200">
            <div id="upload-step">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Krok 1: Wgraj pliki PDF</h2>
                <div id="drop-zone" class="drop-zone w-full rounded-lg p-10 text-center transition duration-300 ease-in-out">
                    <input type="file" id="file-input" class="hidden" accept=".pdf" multiple>
                    <label for="file-input" class="cursor-pointer">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                        <p class="mt-2 text-sm text-gray-600">
                            <span class="font-semibold text-indigo-600">Kliknij, aby wybrać pliki</span> lub przeciągnij je tutaj.
                        </p>
                    </label>
                </div>
                <div id="status" class="mt-4 text-center"></div>
            </div>
            <div id="editor-step" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Krok 2: Edytuj linki</h2>
                <div id="files-container"></div>
            </div>
            <div id="generate-step" class="hidden mt-8 text-center">
                <button id="generate-pdf-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Krok 3: Wygeneruj i pobierz
                </button>
            </div>
        </main>
    </div>

    <script>
        window.addEventListener('load', () => {
            const { PDFDocument, PDFName, PDFString } = PDFLib;
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

            let loadedFiles = [];

            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const statusDiv = document.getElementById('status');
            const uploadStep = document.getElementById('upload-step');
            const editorStep = document.getElementById('editor-step');
            const generateStep = document.getElementById('generate-step');
            const filesContainer = document.getElementById('files-container');
            const generatePdfBtn = document.getElementById('generate-pdf-btn');
            const backToStartBtn = document.getElementById('back-to-start-btn');

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files); });
            fileInput.addEventListener('change', () => { if (fileInput.files.length > 0) handleFiles(fileInput.files); });
            backToStartBtn.addEventListener('click', resetToInitialState);

            function decodePdfString(encodedString) {
                if (!encodedString) return '';
                try {
                    return encodedString.replace(/\\(\d{3})/g, (match, octal) => String.fromCharCode(parseInt(octal, 8)));
                } catch (e) {
                    console.warn('Could not decode string:', encodedString, e);
                    return encodedString;
                }
            }

            async function generateThumbnail(fileBytes) {
                try {
                    const pdf = await pdfjsLib.getDocument({ data: fileBytes }).promise;
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 0.2 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    return canvas.toDataURL('image/jpeg', 0.5);
                } catch (error) {
                    console.error("Błąd podczas generowania miniaturki:", error);
                    return 'https://placehold.co/100x141/e2e8f0/94a3b8?text=B%C5%82%C4%85d';
                }
            }

            async function handleFiles(files) {
                showLoader(`Przetwarzanie ${files.length} plików...`);
                const pdfFiles = Array.from(files).filter(file => file.type === 'application/pdf');
                if (pdfFiles.length === 0) {
                    showStatus('Proszę wybrać pliki w formacie PDF.', true);
                    return;
                }
                const newFilesData = [];
                for (const file of pdfFiles) {
                    const fileBytes = await file.arrayBuffer();
                    try {
                        const pdfDoc = await PDFDocument.load(fileBytes, { updateMetadata: false });
                        const thumbnailUrl = await generateThumbnail(fileBytes.slice(0));
                        const fileLinks = [];
                        const pages = pdfDoc.getPages();
                        for (const page of pages) {
                            const annots = page.node.Annots()?.asArray() ?? [];
                            for (const annotRef of annots) {
                                const annot = pdfDoc.context.lookup(annotRef);
                                if (annot.get(PDFName.of('Subtype')) === PDFName.of('Link')) {
                                    const action = annot.get(PDFName.of('A'));
                                    if (action?.get(PDFName.of('S')) === PDFName.of('URI')) {
                                        const uriString = action.get(PDFName.of('URI'))?.asString();
                                        if (uriString) {
                                            const decodedUri = decodePdfString(uriString);
                                            fileLinks.push({ original: decodedUri, corrected: decodedUri, annotRef });
                                        }
                                    }
                                }
                            }
                        }
                        if (fileLinks.length > 0) {
                            newFilesData.push({ name: file.name, pdfDoc, links: fileLinks, history: [], thumbnailUrl });
                        }
                    } catch (error) {
                        console.error(`Błąd podczas przetwarzania pliku ${file.name}:`, error);
                        showStatus(`Wystąpił błąd podczas odczytu pliku ${file.name}.`, true);
                    }
                }
                if (newFilesData.length === 0) {
                    showStatus('Nie znaleziono żadnych linków w wybranych plikach PDF.', true);
                    return;
                }
                loadedFiles = newFilesData;
                displayFiles();
                showStatus('');
                uploadStep.classList.add('hidden');
                editorStep.classList.remove('hidden');
                generateStep.classList.remove('hidden');
                backToStartBtn.classList.remove('hidden');

                if (loadedFiles.length === 1) {
                    generatePdfBtn.textContent = 'Krok 3: Wygeneruj i pobierz PDF';
                } else {
                    generatePdfBtn.textContent = 'Krok 3: Wygeneruj i pobierz ZIP';
                }
            }

            function displayFiles() {
                filesContainer.innerHTML = '';
                loadedFiles.forEach((file, fileIndex) => {
                    const fileSection = document.createElement('div');
                    fileSection.className = 'file-section mb-10 border border-gray-300 rounded-xl p-4 shadow-md';
                    fileSection.innerHTML = `
                        <h3 class="text-xl font-bold mb-3 text-gray-800">${escapeHTML(file.name)}</h3>
                        <div class="utm-warning-container mb-4"></div>
                        <div class="find-replace-local bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
                            <div class="flex flex-col sm:flex-row items-center gap-4">
                                <input type="text" placeholder="Znajdź w tym pliku..." class="find-input-local flex-grow w-full p-2 border rounded-md border-gray-300 focus:ring-1 focus:ring-indigo-500">
                                <input type="text" placeholder="Zamień na..." class="replace-input-local flex-grow w-full p-2 border rounded-md border-gray-300 focus:ring-1 focus:ring-indigo-500">
                                <div class="flex w-full sm:w-auto gap-2">
                                    <button data-file-index="${fileIndex}" class="replace-all-local-btn w-full sm:w-auto bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition">Zamień</button>
                                    <button data-file-index="${fileIndex}" class="undo-btn w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition disabled:bg-blue-300 disabled:cursor-not-allowed" title="Cofnij ostatnią zmianę">Cofnij</button>
                                </div>
                            </div>
                            <div class="replace-status-local mt-2 text-sm text-gray-600 h-5"></div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-28">Podgląd</th>
                                        <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Oryginalny Link</th>
                                        <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Poprawiony Link (kliknij, aby edytować)</th>
                                    </tr>
                                </thead>
                                <tbody data-tbody-for-file="${fileIndex}" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    `;
                    filesContainer.appendChild(fileSection);
                    updateTableForFile(fileIndex);
                });
            }
            
            filesContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('replace-all-local-btn')) {
                    const fileIndex = e.target.dataset.fileIndex;
                    handleReplaceForFile(fileIndex);
                }
                if (e.target.classList.contains('undo-btn')) {
                    const fileIndex = e.target.dataset.fileIndex;
                    handleUndoForFile(fileIndex);
                }
                if (e.target.classList.contains('select-utm-btn')) {
                    const fileIndex = e.target.dataset.fileIndex;
                    const utm = e.target.dataset.utm;
                    handleSelectUtm(fileIndex, utm);
                }
                const cell = e.target.closest('.editable-cell');
                if (cell) {
                    const row = cell.closest('tr');
                    const fileIndex = row.dataset.fileIndex;
                    const linkIndex = row.dataset.linkIndex;
                    makeCellEditable(cell, fileIndex, linkIndex);
                }
            });

            filesContainer.addEventListener('input', (e) => {
                if (e.target.classList.contains('find-input-local')) {
                    const section = e.target.closest('.file-section');
                    const fileIndex = section.querySelector('.replace-all-local-btn').dataset.fileIndex;
                    const status = section.querySelector('.replace-status-local');
                    updateMatchCount(fileIndex, e.target.value, status);
                }
            });

            function pushToHistory(fileIndex) {
                const file = loadedFiles[fileIndex];
                file.history.push(structuredClone(file.links));
            }

            function updateMatchCount(fileIndex, findValue, statusElement) {
                if (!findValue) { statusElement.textContent = ''; return; }
                const file = loadedFiles[fileIndex];
                if (!file) return;
                const findValueRegex = new RegExp(findValue.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g');
                let totalOccurrences = 0;
                file.links.forEach(link => {
                    totalOccurrences += (link.corrected.match(findValueRegex) || []).length;
                });
                statusElement.textContent = totalOccurrences > 0 ? `Znaleziono ${totalOccurrences} wystąpień.` : 'Nie znaleziono frazy.';
            }

            function handleReplaceForFile(fileIndex) {
                const section = filesContainer.querySelector(`.file-section:nth-child(${+fileIndex + 1})`);
                const findInput = section.querySelector('.find-input-local');
                const replaceInput = section.querySelector('.replace-input-local');
                const findValue = findInput.value;
                const replaceValue = replaceInput.value;

                if (findValue === '') return;
                
                pushToHistory(fileIndex);
                let totalReplaced = 0;
                const file = loadedFiles[fileIndex];
                file.links.forEach(link => {
                    const occurrences = (link.corrected.match(new RegExp(findValue.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g')) || []).length;
                    if (occurrences > 0) {
                        totalReplaced += occurrences;
                        link.corrected = link.corrected.replaceAll(findValue, replaceValue);
                    }
                });
                if (totalReplaced > 0) {
                    updateTableForFile(fileIndex);
                } else {
                    file.history.pop();
                }
            }
            
            function handleUndoForFile(fileIndex) {
                const file = loadedFiles[fileIndex];
                if (!file || file.history.length === 0) return;
                file.links = file.history.pop();
                updateTableForFile(fileIndex);
            }

            function handleSelectUtm(fileIndex, selectedUtm) {
                pushToHistory(fileIndex);
                const file = loadedFiles[fileIndex];
                file.links.forEach(link => {
                    const baseUrl = link.corrected.split('?')[0];
                    link.corrected = baseUrl + selectedUtm;
                });
                updateTableForFile(fileIndex);
            }

            function makeCellEditable(cell, fileIndex, linkIndex) {
                const contentDiv = cell.querySelector('.editable-cell-content');
                if (!contentDiv) return;
                const link = loadedFiles[fileIndex].links[linkIndex];
                const currentValue = link.corrected;
                const textarea = document.createElement('textarea');
                textarea.value = currentValue;
                textarea.className = 'seamless-textarea';
                cell.replaceChild(textarea, contentDiv);
                textarea.style.height = 'auto';
                textarea.style.height = `${textarea.scrollHeight}px`;
                textarea.focus();
                const finishEditing = () => {
                    const newValue = textarea.value.trim();
                    if (newValue !== currentValue) {
                        pushToHistory(fileIndex);
                        link.corrected = newValue;
                    }
                    updateTableForFile(fileIndex);
                };
                textarea.addEventListener('blur', finishEditing);
                textarea.addEventListener('input', () => { textarea.style.height = 'auto'; textarea.style.height = `${textarea.scrollHeight}px`; });
                textarea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); textarea.blur(); } 
                    else if (e.key === 'Escape') { textarea.value = currentValue; textarea.blur(); }
                });
            }

            function getUtmString(url) {
                const utmIndex = url.indexOf('?utm_');
                if (utmIndex !== -1) {
                    return url.substring(utmIndex);
                }
                return null;
            }

            function checkUtmConsistency(fileIndex) {
                const file = loadedFiles[fileIndex];
                const warningContainer = filesContainer.querySelector(`.file-section:nth-child(${+fileIndex + 1}) .utm-warning-container`);
                if (!file || !warningContainer) return;

                const utmSet = new Set();
                file.links.forEach(link => {
                    const utm = getUtmString(link.corrected);
                    if (utm) {
                        utmSet.add(utm);
                    }
                });

                if (utmSet.size > 1) {
                    const utms = Array.from(utmSet).map(utm => `
                        <li class="flex items-center justify-between py-1">
                            <code class="text-xs mr-4">${escapeHTML(utm)}</code>
                            <button data-file-index="${fileIndex}" data-utm="${escapeHTML(utm)}" class="select-utm-btn bg-green-600 text-white text-xs font-bold py-1 px-2 rounded hover:bg-green-700 transition">Użyj tego zestawu</button>
                        </li>`).join('');
                    warningContainer.innerHTML = `
                        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                            <p class="font-bold">Błąd spójności UTM</p>
                            <p>Wykryto wiele różnych zestawów parametrów UTM w tym pliku. Wybierz poprawny, aby ujednolicić wszystkie linki:</p>
                            <ul class="list-none mt-2">${utms}</ul>
                        </div>
                    `;
                } else {
                    warningContainer.innerHTML = '';
                }
            }
            
            function updateTableForFile(fileIndex) {
                const file = loadedFiles[fileIndex];
                const tableBody = filesContainer.querySelector(`tbody[data-tbody-for-file="${fileIndex}"]`);
                if (!tableBody) return;
                const tableRowsHTML = file.links.map((link, linkIndex) => {
                    const isModified = link.corrected !== link.original;
                    const modifiedClass = isModified ? 'cell-modified' : '';
                    const originalLinkHTML = `<a href="${escapeHTML(link.original)}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline" title="Otwórz link w nowej karcie">${escapeHTML(link.original)}</a>`;
                    
                    let thumbnailCell = '';
                    if (linkIndex === 0) {
                        thumbnailCell = `<td class="align-middle" rowspan="${file.links.length}"><img src="${file.thumbnailUrl}" alt="Miniaturka ${escapeHTML(file.name)}" class="w-24 h-auto border border-gray-300 rounded-md shadow-sm mx-auto"></td>`;
                    }

                    return `
                        <tr data-file-index="${fileIndex}" data-link-index="${linkIndex}">
                            ${thumbnailCell}
                            <td class="text-sm font-mono break-all">${originalLinkHTML}</td>
                            <td class="text-sm font-mono break-all editable-cell ${modifiedClass}">
                                <div class="editable-cell-content">${escapeHTML(link.corrected)}</div>
                            </td>
                        </tr>
                    `;
                }).join('');
                tableBody.innerHTML = tableRowsHTML;
                const undoBtn = filesContainer.querySelector(`.undo-btn[data-file-index="${fileIndex}"]`);
                if(undoBtn) {
                    undoBtn.disabled = file.history.length === 0;
                }
                checkUtmConsistency(fileIndex);
            }

            generatePdfBtn.addEventListener('click', async () => {
                if (loadedFiles.length === 0) {
                    showStatus('Błąd: Brak załadowanych plików do przetworzenia.', true);
                    return;
                }
                showLoader('Generowanie plików...');
                editorStep.classList.add('hidden');
                generateStep.classList.add('hidden');
                backToStartBtn.classList.add('hidden');

                try {
                    if (loadedFiles.length === 1) {
                        const file = loadedFiles[0];
                        file.links.forEach(link => {
                            if (link.original !== link.corrected) {
                                const annot = file.pdfDoc.context.lookup(link.annotRef);
                                if (annot) {
                                    const action = annot.get(PDFName.of('A'));
                                    if (action) action.set(PDFName.of('URI'), PDFString.of(link.corrected));
                                }
                            }
                        });
                        const newPdfBytes = await file.pdfDoc.save();
                        const updatedFileName = file.name.replace(/\.pdf$/i, '_zaktualizowany.pdf');
                        const blob = new Blob([newPdfBytes], { type: 'application/pdf' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = updatedFileName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } 
                    else {
                        const zip = new JSZip();
                        for (const file of loadedFiles) {
                            file.links.forEach(link => {
                                if (link.original !== link.corrected) {
                                    const annot = file.pdfDoc.context.lookup(link.annotRef);
                                    if (annot) {
                                        const action = annot.get(PDFName.of('A'));
                                        if (action) action.set(PDFName.of('URI'), PDFString.of(link.corrected));
                                    }
                                }
                            });
                            const newPdfBytes = await file.pdfDoc.save();
                            const updatedFileName = file.name.replace(/\.pdf$/i, '_zaktualizowany.pdf');
                            zip.file(updatedFileName, newPdfBytes);
                        }
                        const zipBlob = await zip.generateAsync({ type: 'blob' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(zipBlob);
                        link.download = 'zaktualizowane_pliki_pdf.zip';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                    showStatus('Pliki zostały pomyślnie wygenerowane.', false);
                    setTimeout(resetToInitialState, 3000);
                } catch(error) {
                    console.error('Błąd podczas generowania plików:', error);
                    showStatus('Wystąpił błąd podczas zapisywania plików.', true);
                    editorStep.classList.remove('hidden');
                    generateStep.classList.remove('hidden');
                    backToStartBtn.classList.remove('hidden');
                }
            });

            function escapeHTML(str) {
                const p = document.createElement('p');
                p.textContent = str;
                return p.innerHTML;
            }
            
            function showStatus(message, isError = false) {
                statusDiv.innerHTML = `<p class="${isError ? 'text-red-600' : 'text-green-600'}">${message}</p>`;
            }

            function showLoader(message) {
                statusDiv.innerHTML = `<div class="flex items-center justify-center"><div class="loader mr-3"></div><p>${message}</p></div>`;
            }
            
            function resetToInitialState() {
                loadedFiles = [];
                filesContainer.innerHTML = '';
                statusDiv.innerHTML = '';
                fileInput.value = null;
                uploadStep.classList.remove('hidden');
                editorStep.classList.add('hidden');
                generateStep.classList.add('hidden');
                backToStartBtn.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
